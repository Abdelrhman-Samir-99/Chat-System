# Instabug Task #

# System requirements #
We should create a RESTFul API for a system that creates (applications -> chats -> messages) with the following requirements:

## Functional Requirements ##
+ We should be able to create applications.
    + Should have a unique token generated by the system.
    + chats_count: which represent the current number of chats in it.
+ We should be able to add chats by using application token.
    + Every chat should be having a Chat_id
        + Must be unique.
        + Starting from 1.
     + When we create or delete a chat, chats_count should be updated in the application table.
+ We should be able to messages in specific chat, by using Chat_id and application token.
    + Every message should have a message_id
         + Must be unique.
         + Starting from 1.
    + When we create or delete a message, messages_count should be updated in the chat table.
+ We would like to do partial search on the messages.

## non-functional requirements ##
+ We should maintain the referential integrity.
+ We should take care about race conditions.
+ We should use ElasticSearch for the partial search.
+ We should consider using a message queue to do some process in the back ground.
+ We should add indecies in our databases to get a better query performance.
+ We may consider using a cache.
+ We should write specs for our API.
    


## Database (Models) ##

![dbSchema](https://user-images.githubusercontent.com/77211992/150012374-2260b7ed-fe86-48b1-84a4-f1ffd9f4d868.png)

### Indecies ###
+ there is a default index on each key.
+ I made 2 other indecies
    + Chat model -> (id, Application_id)
    + Message model -> ()
+ I used transaction and pessimistic locks to:
    + handle race conditions.
    + make sure that I updated the chats_count/ messages_count. (I believe that there is something in ActiveRecord that can handle that automatically, not sure)
+ I used Redis cache: But not as I wished to do
    + I didn't implement eviction strategy, due to lack of time + first time ever to use it.
    + I wished if I can implement LRU or LFU cache (I can implement both in C++).
    + Used it to cache the messages_count and chats_count. (didn't know what else to cache)
    + There is a bug with the chats_count_cache which is always off by one, so I'm just not using it for now, but works fine for messages_count (hopefully!).
 
## Controllers ##
+ ApplicationsController: Handling everything related to the application
+ ChatsController: Handling everything related to the chat.
+ MessagesController: Handling everyhing related to the message.
## Routes ##
+ Application routes:
    + POST methods:
        + `/application/create/:name` Creating a new application.
    + GET methods:
        + `/application/index` Shows all applications.
        + `/application/show/:application_token` Shows a specific application.
    + DELETE methods:
        + `/application/delete/:application_token` Delete a specific application with all of its chats and messages.
+ Chat routes:
    + POST methods:
        + `application/:application_token/chat/create` Creating a new chat in a specific application.
    + GET methods:
        + `/application/:application_token/chat/index` Shows all chats in a specific application.
        + `/application/:application_token/chat/show/:Chat_id` Shows a specific chat using Chat_ID.
    + DELETE methods: 
        + `/application/:application_token/chat/delete/:Chat_id` Delete a specific chat with is messages.
+ Message routes:
    + POST methods: 
        + `/application/:application_token/chat/:Chat_id/message/create/:body` Creating a new message.
    + GET methods: 
        + `/application/:application_token/chat/:Chat_id/message/index` Shows all messages for a specfic chat.
        + `/application/:application_token/chat/:Chat_id/message/show/:message_id` Shows a specfic message in a specific chat.
    + PUT methods: 
        + `/application/:application_token/chat/:Chat_id/message/update/:message_id/:body` Updating a specific message.
    + DELETE methods: 
        + `/application/:application_token/chat/:Chat_id/message/delete/:message_id` Delete a specific message.

## ElasticSearch ##
+ I couldn't complete this task fully, but I wantched the first two lectures for the ElasticSearch on their official youtube channel and also I was following this [blog](https://iridakos.com/programming/2017/12/03/elasticsearch-and-rails-tutorial), but I had an error when I was creating index for the message model that I couldn't solve (or find a solution).
+ My idea is just to make a single index for the Message model, and elasticsearch will fetch all the messages that are relevant to our query.
    + I'm not sure if we can include the Application_id, Chat_id in our query or not, but if not then we can just filter the JSON result.
    + I had a good experience with Kibana as well.
And I would like to thank you for letting me know about this microservice "I believe".
## Message Queue ##
+ I didn't even have enough time for this, since I had to learn ROR and this is actually my first RESTFul API to implement.
+ I have a little knowledge about message queue and how the handle loads on the server, by serving specific amount of customers/threads and use a database with {key, value} pair to save the result.
+ But since I'm just graduated, and don't really have work experience. I never exposed to a message queue as implementation, but I believe I used it once in Java while doing a multi-threading task.
